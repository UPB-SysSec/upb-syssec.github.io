---
layout: distill
title: "HTTP/2 Circumvention"
date: 2024-10-31
description: "Exploring HTTP/2 as a censorship circumvention possibility"
citation: true

authors:
  - name: Felix Lange*
    affiliations:
        name: Paderborn University
    bibtex: Lange, Felix
  - name: Niklas Niere*
    affiliations:
        name: Paderborn University
    url: https://twitter.com/JonSnowWhite2
    bibtex: Niere, Niklas
  - name: Jonathan von Niessen*
    affiliations:
        name: Paderborn University
    bibtex: von Niessen, Jonathan

bibliography: http2.bib

toc:
    - name: Abstract
    - name: Introduction and Background
      subsections: 
        - name: HTTP (Censorship)
        - name: HTTP/2
          subsections:
            - name: Prior Knowledge
            - name: Upgrade Mechanism
        - name: Research Gap
    - name: Contributions
      subsections:
      - name: Censorship
      - name: Server Support
        subsections:
          - name: Unencrypted HTTP/1.1 Support
          - name: Unencrypted HTTP/2 with Prior Knowledge Support
          - name: Unencrypted HTTP/2 with Upgrade Mechanism Support
          - name: Tranco Relation
          - name: Tool for Detecting HTTP Support
    - name: Discussion
      subsections:
        - name: What makes unencrypted HTTP/2 special?
        - name: Difficulty of blocking unencrypted HTTP/2
        - name: Circumventing Censors with unencrypted HTTP/2
    - name: Conclusion

---
*Authors in alphabetical order - all contributed equally

## Abstract
Censors around the world have long censored unencrypted HTTP traffic.
In this blog post, we show that a specific HTTP version---unencrypted HTTP/2--- is unaffected by censorship in China and Iran.
We access otherwise censored websites in both countries over unencrypted HTTP/2.
Despite no web browser implementing unencrypted HTTP/2, we detect that between 13% and 26% of websites that support unencrypted HTTP/2 traffic.
To aid the community and ease future research, we provide a tool that evaluates the unencrypted HTTP support of a website.
Finally, we discuss the limitations and potential of unencrypted HTTP/2 for censorship circumvention.
We consider our finding an interesting addition to current censorship circumvention techniques.


## Introduction and Background
In this section, we provide background information on HTTP and its censorship. We place special emphasis on HTTP/2 and its comparison to previous HTTP versions.

### HTTP (Censorship)
<!--General HTTP -->


<!-- Censorship of unencrypted HTTP -->
HTTP is one of the main protocols used throughout the Internet for accessing websites.
While HTTP is usually used in conjunction with TLS, censorship of the plain HTTP protocol is still present and prior research analyzed the most common version HTTP/1.1&nbsp;<d-cite key="RFC9112"/> extensively&nbsp;<d-cite key="harrity_GETOutAutomated_2022,jin_UnderstandingPracticesGlobal_2021,bock_DetectingEvadingCensorshipinDepth_2020"/>.
These works discovered that censors such as the ones in China and Iran use information in the Host header and path to determine whether an HTTP request should be censored.
An example HTTP/1.1 GET request with a censored path value and Host header can be seen here:
```
GET /<censored_keyword> HTTP/1.1  
Host: <censored_domain>
```
If a request should be censored, the censor can inject TCP RST packets, inject an HTTP block page, or null-route the whole connection&nbsp;<d-cite key="bock_YourCensorMy_2021"/>.

### HTTP/2
<!--General HTTP/2 and its different because byte based -->
As outlined above, many works exist that analyze HTTP/1.1 censorship but there is a lack of research for the newer version: HTTP/2&nbsp;<d-cite key="RFC9113"/>.
HTTP/2 maintains the same semantics as its predecessor, uses the same port numbers, and still uses TCP.
However, it now consists of binary data directly and is not text-based anymore.
Arguably, this makes it harder for a censor to parse, analyze, and censor HTTP/2 connections as it requires some initial effort to implement the new parsing mechanisms.
When a client wants to connect to a server with HTTP/2, there are two main ways of doing so: with prior knowledge or the Upgrade mechanisms.
In the following, we describe both ways.

#### Prior Knowledge
<!--Prior knowledge -->
During prior knowledge, the client directly attempts to speak HTTP/2 with the server.
As the initial step, the client establishes a TCP connection with the server.
Then, the client sends the so-called connection preface, followed by a **SETTINGS** frame.
This connection preface was specified to trigger an error on HTTP servers that do not support HTTP/2.
The **SETTINGS** frame contains additional configuration parameters for the connection.
If the server supports HTTP/2, it can process the preface and responds with its own connection preface, containing a **SETTINGS** frame.

#### Upgrade Mechanism
<!-- Upgrade -->
Initially defined by RFC 7540&nbsp;<d-cite key="RFC7540"/>, the Upgrade mechanism has been deprecated since RFC 9113&nbsp;<d-cite key="RFC9113"/> as it was not widely adopted.
During the Upgrade mechanism, the client establishes a TCP connection with the server and then sends an HTTP/1.1 request, including the Upgrade and HTTP2-Settings headers.
An example HTTP/1.1 Upgrade request can look like this:
```
GET / HTTP/1.1  
Host: server.example.com
Connection: Upgrade, HTTP2-Settings
Upgrade: h2c
HTTP2-Settings: <base64url encoding of HTTP/2 SETTINGS payload>
```
If the server supports the Upgrade mechanism, it responds with a 101 status code, indicating **Switching Protocols**, and then transitions to an HTTP/2 connection.
An example successful server answer can look like this:
```
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: h2c
[ HTTP/2 answer for "GET /" ...
```

### Research Gap
<!-- HTTP/2 in general only used encrypted but WHAT IF? -->
As HTTP/2 has not been analyzed extensively yet in the context of censorship, we asked ourselves the following questions:
1. Is HTTP/2 censored in countries that employ HTTP/1.1 censorship?
2. How widely is plain HTTP/1.1 supported?
3. How widely is HTTP/2 supported with prior knowledge and the Upgrade mechanism?

In the following, we give an updated look on HTTP censorship in China and Iran.

## Contributions

In the following, we first present the results of our HTTP censorship analysis for both countries.
Then, we detail the findings of our HTTP version server support scan.

### Censorship
In China, HTTP/1.1 is censored with a combination of different TCP RST packets with the ACK flag set or not, depending on the specific domain.
In Iran, HTTP/1.1 requests are censored with a block page, a TCP RST, or null routing, depending on the specific domain.
However, our key observation in our censorship scans is that HTTP/2 is not censored at all in both countries.

As a censorship circumvention example, we tried to access \url{http://nsfwyoutube.com} in both countries. 
This website is censored in both countries via HTTP/1.1.
We were able to access this website in both countries successfully by using HTTP/2 with prior knowledge.

### Server Support
For the HTTP version server support scan, we used three lists of domains: Tranco top one million, the CitizenLab test list for China, and the CitizenLab test list for Iran.
The following table shows the number of analyzed domains for each scan in each list:

<table style="margin: 0 auto; text-align:center">
<thead>
<tr class="header">
<th style="text-align: left;"><span>List</span></th>
<th style="text-align: left;"><span>HTTP/1.1</span></th>
<th style="text-align: left;"><span>Prior Knowledge</span></th>
<th style="text-align: left;"><span>Upgrade Mechanism</span></th>
</tr>
</thead>
<tbody>
<tr>
<th style="text-align: left;"><span>Tranco Top 1M</span></th>
<th style="text-align: right;"><span>839 375</span></th>
<th style="text-align: right;"><span>839 393</span></th>
<th style="text-align: right;"><span>839 374</span></th>
</tr>
<tr>
<th style="text-align: left;"><span>CitizenLab China</span></th>
<th style="text-align: right;"><span>496</span></th>
<th style="text-align: right;"><span>496</span></th>
<th style="text-align: right;"><span>496</span></th>
</tr>
<tr>
<th style="text-align: left;"><span>CitizenLab Iran</span></th>
<th style="text-align: right;"><span>748</span></th>
<th style="text-align: right;"><span>749</span></th>
<th style="text-align: right;"><span>748</span></th>
</tr>
</tbody>
</table><br>

Notably, the number of domains for each scan changes slightly because of temporarily unavailable websites.
During all scans, we analyzed and followed all received redirects.
The overall results can be seen in the following table:

<table style="margin: 0 auto; text-align:center">
<thead>
<tr class="header">
<th style="text-align: left;"><span>List</span></th>
<th style="text-align: left;"><span>HTTP/1.1</span></th>
<th style="text-align: left;"><span>Prior Knowledge</span></th>
<th style="text-align: left;"><span>Upgrade Mechanism</span></th>
</tr>
</thead>
<tbody>
<tr>
<th style="text-align: left;"><span>Tranco Top 1M</span></th>
<th style="text-align: right;"><span>156 316 (18.62%)</span></th>
<th style="text-align: right;"><span>20 973 (2.50%)</span></th>
<th style="text-align: right;"><span>5227 (0.62%)</span></th>
</tr>
<tr>
<th style="text-align: left;"><span>CitizenLab China</span></th>
<th style="text-align: right;"><span>96 (19.35%)</span></th>
<th style="text-align: right;"><span>24 (4.84%)</span></th>
<th style="text-align: right;"><span>3 (0.60%)</span></th>
</tr>
<tr>
<th style="text-align: left;"><span>CitizenLab Iran</span></th>
<th style="text-align: right;"><span>161 (21.52%)</span></th>
<th style="text-align: right;"><span>47 (6.28%)</span></th>
<th style="text-align: right;"><span>13 (1.74%)</span></th>
</tr>
</tbody>
</table><br>

#### Unencrypted HTTP/1.1 Support
During the unencrypted HTTP/1.1 support scan, we sent the following test vector for all domains:
```
GET / HTTP/1.1
Host: <domain_name>
User-Agent: Mozilla/5.0 (...) Gecko/20100101 Firefox/127.0
Connection: close
```

Across the three used lists, the HTTP/1.1 support varies between 18.62\% and 21.52\%.
These results show that - surprisingly - unencrypted HTTP/1.1 is still supported by many domains.

#### Unencrypted HTTP/2 with Prior Knowledge Support
During the unencrypted HTTP/2 with prior knowledge scan, we sent the connection preface first and then the following test vector for all domains:
```
GET / HTTP/2
Host: <domain_name>
User-Agent: Mozilla/5.0 (...) Gecko/20100101 Firefox/127.0
```

The HTTP/2 with prior knowledge support varies between 2.5\% and 6.28\%, depending on the domain list. 
This shows that while the support of HTTP/2 is lower than the one of HTTP/1.1 for all lists, it is still being used by some websites.

#### Unencrypted HTTP/2 with Upgrade Mechanism Support
During the unencrypted HTTP/2 with upgrade mechanism scan, we sent the following HTTP/1.1 request as a test vector for all domains:
```
GET / HTTP/1.1
Host: <example.com>
User-Agent: Mozilla/5.0 (...) Gecko/20100101 Firefox/127.0
Connection: Upgrade, HTTP2-Settings
Upgrade: h2c
HTTP2-Settings: AAEAABAAAAIAAAABAAQAAP__AAUAAEAAAAgAAAA...
```

The upgrade mechanism has the lowest support ranging from 0.6\% to 1.74\%, depending on the used domain list. 
This makes sense as RFC 9113&nbsp;<d-cite key="RFC9113"/> deprecated this method due to its low adoption rate.

#### Tranco Relation
<img src="/assets/img/2024/http2/tranco.svg" alt="Unencrypted HTTP support by servers from the Tranco Top 1 Million list.">
<div class="caption">
Unencrypted HTTP support by servers from the Tranco Top 1 Million list. Unencrypted HTTP/2 support increases for less accessed websites, contrasting unencrypted HTTP/1.
</div>

Unencrypted HTTP/1.1 support mostly between 10 and 35\%.
Unencrypted HTTP/2 support up to 5\% for lower Tranco ranks. 
Interestingly, unencrypted HTTP/2 support increases for lower Tranco ranks while unencrypted HTTP/1 support increases until about 400,000 and then decreases again. 
This aligns with support by websites from Citizenlab list which are usually smaller than Tranco websites.
While overall support for HTTP/2 is low, we argue that it can still be used to access certain blocked websites successfully and adds to the arsenal of censorship circumvention techniques.
We discuss this further in ref discussion.

#### Tool for Detecting HTTP Support
During our analyses, we developed a tool that evaluates a website's support for unencrypted HTTP support.
Below, we provide an exemplary output for `lgbtchinatour.com`
```
lgbtchinatour.com analysis started.
Server online. Scanning!

#####################

HTTP/1.0: REDIRECT(www.lgbtchinatour.com/) -> SUCCESS
HTTP/1.1: SUCCESS
HTTP/2 (Prior Knowledge): FAILURE
HTTP/2 (Upgrade): FAILURE
```

This indicates that `lgbtchinatour.com` supports unencrypted HTTP/1.0 after a redirect and unencrypted HTTP/1.1 but no unencrypted HTTP/2.
We refer to the [GitHub project](https://github.com/UPB-SysSec/Raw-HTTP-Support-Analyzer) for a detailed overview of the tool's functionality.
We hope that our tool aids the community and fellow researchers in their evaluation of HTTP censorship and its circumvention.

## Discussion

We have successfully circumvented the HTTP censors in China and Iran and showed that up to 5\% of censored websites are accessible via unencrypted HTTP/2.
This still leaves 95\% of censored websites inaccessible with unencrypted HTTP/2 as a circumvention method.
Despite this, we consider unencrypted HTTP/2 a valuable addition to current censorship circumvention techniques in the cat-and-mouse game between censors and affected people.
Below, we discuss the limitations and potential of unencrypted HTTP/2 as a circumvention technique.

### What makes unencrypted HTTP/2 special?
HTTP/2 differs vastly from previous HTTP versions such as HTTP/1.1.
While all HTTP versions up to and including HTTP/1.1 consist of human-readable ASCII letters, HTTP/2 is a byte-based protocol.
This makes HTTP/2 parsers incompatible with previous HTTP parsers.
Furthermore, HTTP/2 has been designed for encrypted usage in HTTPS. 
Unencrypted usage is allowed but not advertised.
Accordingly, browsers do not implement unencrypted HTTP/2.
We suspect that this is the reason censors do not analyze it and why the censorship circumvention community has ignored unencrypted HTTP/2.

### Difficulty of blocking unencrypted HTTP/2
Censors can block HTTP/2 but face additional challenges compared to previous HTTP versions.
For previous HTTP versions, censors could analyze the first message sent by the client to extract the connection's destination from human-readable ASCII bytes.
In HTTP/2 the first message must not necessarily contain the connection destination forcing the censor to hold additional state and parse additional messages.
HTTP/2 also utilizes a new form of header compression which censors would have to accommodate.
We suspect that the complexity added in HTTP/2 contributed to the censors' decision not to analyze it.
We also emphasize that censors could still implement HTTP/2 censorship despite its complexity.


### Circumventing Censors with unencrypted HTTP/2
Practically applying unencrypted HTTP/2 as a censorship circumvention technique is possible but comes with challenges.
In this blog post, we accessed otherwise blocked resources with unencrypted HTTP/2 using curl.
Curl's built-in support for unencrypted HTTP/2 can be used to access specific HTML sites but its usability is limited in comparison to a full-blown web browser.
Unfortunately, we are not aware of any web browser that supports unencrypted HTTP/2.
To utilize unencrypted HTTP/2 as a censorship circumvention technique from a browser, we propose an HTTP update proxy that translates unencrypted HTTP/1.1 spoken by the browser into unencrypted HTTP/2 and vice-versa.
A similar proxy could be installed on the other side of the firewall, downgrading unencrypted HTTP/2 to unencrypted HTTP/1.1, allowing unencrypted HTTP/2 traffic to pass the censor and connect to a server that only supports unencrypted HTTP/1.1.
Overall, we consider the practical deployment of HTTP/2 as a censorship circumvention method difficult and are interested in possible approaches.

## Conclusion
In summary, we introduced unencrypted HTTP/2 as a censorship circumvention method by accessing blocked resources in China and Iran.
While server support for unencrypted HTTP/2 is low, we showed that a non-negligible number of censored websites supports it.
To aid future evaluations of servers' support for unencrypted HTTP/2, we developed a tool and made it accessible on GitHub.
Feel free to use it or contact us for further discussion and future work.
We hope that our contributions aid affected people and the censorship circumvention community.
